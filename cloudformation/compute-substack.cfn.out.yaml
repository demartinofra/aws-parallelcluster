---
Parameters:
  SNS:
    Type: String
  ComputeSecurityGroup:
    Type: String
  KeyName:
    Type: String
  RootInstanceProfile:
    Type: String
  ImageId:
    Type: AWS::EC2::Image::Id
  S3Domain:
    Type: String
  RootRole:
    Type: String
  EFSId:
    Type: String
  FSXId:
    Type: String
  SQS:
    Type: String
  MasterServerPrivateDns:
    Type: String
  MainStackName:
    Type: String
Resources:
  ASGqueue1c5xlarge:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      MaxSize: '1'
      VPCZoneIdentifier:
        - subnet-0f45a3009addd0e7f
      LaunchTemplate:
        LaunchTemplateId: !Ref LaunchTemplatequeue1c5xlarge
        Version: !GetAtt 'LaunchTemplatequeue1c5xlarge.LatestVersionNumber'
      MinSize: '1'
      DesiredCapacity: '1'
      NotificationConfigurations:
        - TopicARN: !Ref 'SNS'
          NotificationTypes:
            - autoscaling:EC2_INSTANCE_TERMINATE
            - autoscaling:EC2_INSTANCE_LAUNCH
      PlacementGroup: !Ref AWS::NoValue
      MetricsCollection:
        - Granularity: 1Minute
          Metrics:
            - GroupDesiredCapacity
            - GroupInServiceInstances
            - GroupTerminatingInstances
            - GroupTotalInstances
    CreationPolicy:
      ResourceSignal:
        Timeout: PT30M
        Count: '1'
  LaunchTemplatequeue1c5xlarge:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateData:
        InstanceType: c5.xlarge
        NetworkInterfaces:
          - DeviceIndex: 0
            InterfaceType: !Ref AWS::NoValue
            Groups:
              - !Ref 'ComputeSecurityGroup'
            AssociatePublicIpAddress: true
            SubnetId: subnet-0f45a3009addd0e7f
        KeyName: !Ref 'KeyName'
        IamInstanceProfile:
          Name: !Ref 'RootInstanceProfile'
        ImageId: !Ref 'ImageId'
        Monitoring:
          Enabled: false
        BlockDeviceMappings:
          - DeviceName: /dev/xvdba
            VirtualName: ephemeral0
          - DeviceName: /dev/xvdbb
            VirtualName: ephemeral1
          - DeviceName: /dev/xvdbc
            VirtualName: ephemeral2
          - DeviceName: /dev/xvdbd
            VirtualName: ephemeral3
          - DeviceName: /dev/xvdbe
            VirtualName: ephemeral4
          - DeviceName: /dev/xvdbf
            VirtualName: ephemeral5
          - DeviceName: /dev/xvdbg
            VirtualName: ephemeral6
          - DeviceName: /dev/xvdbh
            VirtualName: ephemeral7
          - DeviceName: /dev/xvdbi
            VirtualName: ephemeral8
          - DeviceName: /dev/xvdbj
            VirtualName: ephemeral9
          - DeviceName: /dev/xvdbk
            VirtualName: ephemeral10
          - DeviceName: /dev/xvdbl
            VirtualName: ephemeral11
          - DeviceName: /dev/xvdbm
            VirtualName: ephemeral12
          - DeviceName: /dev/xvdbn
            VirtualName: ephemeral13
          - DeviceName: /dev/xvdbo
            VirtualName: ephemeral14
          - DeviceName: /dev/xvdbp
            VirtualName: ephemeral15
          - DeviceName: /dev/xvdbq
            VirtualName: ephemeral16
          - DeviceName: /dev/xvdbr
            VirtualName: ephemeral17
          - DeviceName: /dev/xvdbs
            VirtualName: ephemeral18
          - DeviceName: /dev/xvdbt
            VirtualName: ephemeral19
          - DeviceName: /dev/xvdbu
            VirtualName: ephemeral20
          - DeviceName: /dev/xvdbv
            VirtualName: ephemeral21
          - DeviceName: /dev/xvdbw
            VirtualName: ephemeral22
          - DeviceName: /dev/xvdbx
            VirtualName: ephemeral23
          - DeviceName: /dev/xvda
            Ebs:
              VolumeSize: 25
              VolumeType: gp2
        UserData:
          Fn::Base64:
            !Sub |
            Content-Type: multipart/mixed; boundary="==BOUNDARY=="
            MIME-Version: 1.0

            --==BOUNDARY==
            Content-Type: text/cloud-boothook; charset=us-ascii
            MIME-Version: 1.0

            #!/bin/bash -x

            which yum && echo "proxy=_none_" >> /etc/yum.conf || echo "Not yum system"
            which apt-get && echo "Acquire::http::Proxy \"false\";" >> /etc/apt/apt.conf || echo "Not apt system"
            proxy=NONE
            if [ ${!proxy} != NONE ]; then
              proxy_host=$(echo "${!proxy}" | awk -F/ '{print $3}' | cut -d: -f1)
              proxy_port=$(echo "${!proxy}" | awk -F/ '{print $3}' | cut -d: -f2)
              echo -e "[Boto]\nproxy = ${!proxy_host}\nproxy_port = ${!proxy_port}\n" > /etc/boto.cfg
              cat >> /etc/profile.d/proxy.sh <<PROXY
            export http_proxy="${!proxy}"
            export https_proxy="${!proxy}"
            export no_proxy="localhost,127.0.0.1,169.254.169.254"
            export HTTP_PROXY="${!proxy}"
            export HTTPS_PROXY="${!proxy}"
            export NO_PROXY="localhost,127.0.0.1,169.254.169.254"
            PROXY
            fi

            --==BOUNDARY==
            Content-Type: text/x-shellscript; charset=us-ascii
            MIME-Version: 1.0

            #!/bin/bash -x

            function error_exit
            {
              region=${AWS::Region}
              instance_id=$(curl --retry 3 --retry-delay 0 --silent --fail http://169.254.169.254/latest/meta-data/instance-id)
              log_dir=/home/logs/compute
              mkdir -p ${!log_dir}
              echo "Reporting instance as unhealthy and dumping logs to ${!log_dir}/${!instance_id}.tar.gz"
              tar -czf ${!log_dir}/${!instance_id}.tar.gz /var/log
              # aws --region ${AWS::Region} autoscaling set-instance-health --instance-id ${!instance_id} --hea lth-status Unhealthy
              cfn-signal --exit-code=1 --reason="$1" --stack="${AWS::StackName}" --resource=ASGqueue1c5xlarge --region=${AWS::Region}
              exit 1
            }
            function vendor_cookbook
            {
              mkdir /tmp/cookbooks
              cd /tmp/cookbooks
              tar -xzf /etc/chef/aws-parallelcluster-cookbook.tgz
              HOME_BAK="${!HOME}"
              export HOME="/tmp"
              for d in `ls /tmp/cookbooks`; do
                cd /tmp/cookbooks/$d
                LANG=en_US.UTF-8 /opt/chef/embedded/bin/berks vendor /etc/chef/cookbooks --delete || error_exit 'Vendoring cookbook failed.'
              done;
              export HOME="${!HOME_BAK}"
            }
            function bootstrap_instance
            {
              which yum 2>/dev/null; yum=$?
              which apt-get 2>/dev/null; apt=$?
              if [ "${!yum}" == "0" ]; then
                yum -y groupinstall development && yum -y install curl wget jq awscli
              fi
              if [ "${!apt}" == "0" ]; then
                apt-cache search build-essential; apt-get clean; apt-get update; apt-get -y install build-essential curl wget jq python-setuptools awscli
              fi
              [[ ${!_region} =~ ^cn- ]] && s3_url="cn-north-1.amazonaws.com.cn/cn-north-1-aws-parallelcluster"
              which cfn-init 2>/dev/null || ( curl -s -L -o /tmp/aws-cfn-bootstrap-latest.tar.gz https://s3.${S3Domain}/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz; easy_install -U /tmp/aws-cfn-bootstrap-latest.tar.gz)
              mkdir -p /etc/chef && chown -R root:root /etc/chef
              curl --retry 3 -L https://www.chef.io/chef/install.sh | bash -s -- -v ${!chef_version}
              /opt/chef/embedded/bin/gem install --no-rdoc --no-ri ridley:${!ridley_version} berkshelf:${!berkshelf_version} ffi-libarchive
              curl --retry 3 -s -L -o /etc/chef/aws-parallelcluster-cookbook.tgz ${!cookbook_url}
              curl --retry 3 -s -L -o /etc/chef/aws-parallelcluster-cookbook.tgz.date ${!cookbook_url}.date
              curl --retry 3 -s -L -o /etc/chef/aws-parallelcluster-cookbook.tgz.md5 ${!cookbook_url}.md5
              vendor_cookbook
              mkdir /opt/parallelcluster && echo ${!parallelcluster_version} | tee /opt/parallelcluster/.bootstrapped
            }
            [ -f /etc/profile.d/proxy.sh ] && . /etc/profile.d/proxy.sh
            custom_cookbook=NONE
            export _region=${AWS::Region}
            s3_url=${S3Domain}

            if [ "NONE" != "NONE" ]; then
              cookbook_url=NONE
            else
              cookbook_url=https://s3.${!_region}.${S3Domain}/${!_region}-aws-parallelcluster/cookbooks/aws-parallelcluster-cookbook-2.6.0.tgz
            fi
            export PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/opt/aws/bin
            export parallelcluster_version=aws-parallelcluster-2.6.0
            export cookbook_version=aws-parallelcluster-cookbook-2.6.0
            export chef_version=14.2.0
            export ridley_version=5.1.1
            export berkshelf_version=7.0.4

            if [ -f /opt/parallelcluster/.bootstrapped ]; then
              installed_version=$(cat /opt/parallelcluster/.bootstrapped)
              if [ "${!parallelcluster_version}" != "${!installed_version}" ]; then
                bootstrap_instance
              fi
            else
              bootstrap_instance
            fi
            if [ "${!custom_cookbook}" != "NONE" ]; then
              curl --retry 3 -v -L -o /etc/chef/aws-parallelcluster-cookbook.tgz -z "$(cat /etc/chef/aws-parallelcluster-cookbook.tgz.date)" ${!cookbook_url}
              vendor_cookbook
            fi
            cd /tmp

            while [ "${!masterServerStatus}" != "CREATE_COMPLETE" ] && [ "${!masterServerStatus}" != "UPDATE_COMPLETE" ]
            do
              sleep 3
              masterServerStatus=$(aws cloudformation describe-stack-resource --stack-name ${MainStackName} --logical-resource-id MasterServerWaitCondition --region ${AWS::Region} --query StackResourceDetail.ResourceStatus --output text 2>/dev/null)
            done

            # Call CloudFormation
            cfn-init -s ${AWS::StackName} -v -c default --role ${RootRole} -r LaunchTemplatequeue1c5xlarge --region ${AWS::Region} || error_exit 'Failed to run cfn-init. If --norollback was specified, check /var/log/cfn-init.log and /var/log/cloud-init-output.log.'
            cfn-signal --exit-code=0 --reason="ComputeServer setup complete" --stack=${AWS::StackName} --resource=ASGqueue1c5xlarge --region=${AWS::Region}

            # End of file
            --==BOUNDARY==
    Metadata:
      Comment: AWS ParallelCluster Compute server
      AWS::CloudFormation::Init:
        configSets:
          default:
            - deployConfigFiles
            - chefPrepEnv
            - shellRunPreInstall
            - chefConfig
            - shellRunPostInstall
            - chefFinalize
        deployConfigFiles:
          files:
            /tmp/dna.json:
              mode: '000644'
              owner: root
              group: root
              content:
                cfncluster:
                  stack_name: !Ref 'MainStackName'
                  enable_efa: false
                  cfn_raid_parameters: NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE
                  cfn_preinstall: NONE
                  cfn_preinstall_args:  NONE
                  cfn_postinstall:  NONE
                  cfn_postinstall_args:  NONE
                  cfn_region: !Ref 'AWS::Region'
                  cfn_efs: !Ref 'EFSId'
                  cfn_efs_shared_dir: NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE
                  cfn_fsx_fs_id: !Ref 'FSXId'
                  cfn_fsx_options: NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE
                  cfn_scheduler: slurm
                  cfn_scheduler_slots: !Ref 'AWS::NoValue'
                  cfn_scaledown_idletime: 10
                  cfn_encrypted_ephemeral: false
                  cfn_ephemeral_dir: /scratch
                  cfn_shared_dir: /shared
                  cfn_proxy: NONE
                  cfn_sqs_queue: !Ref 'SQS'
                  cfn_master: !Ref 'MasterServerPrivateDns'
                  cfn_node_type: ComputeFleet
                  cfn_cluster_user: ec2_user
                  enable_intel_hpc_platform: false
                  cfn_cluster_cw_logging_enabled: true
                run_list: 'recipe[aws-parallelcluster::slurm_config]'
            /etc/chef/client.rb:
              mode: '000644'
              owner: root
              group: root
              content: !Join
                - ''
                - - cookbook_path ['/etc/chef/cookbooks']
            /tmp/extra.json:
              mode: '000644'
              owner: root
              group: root
              content: '{}'
          commands:
            mkdir:
              command: mkdir -p /etc/chef/ohai/hints
            touch:
              command: touch /etc/chef/ohai/hints/ec2.json
            jq:
              command: >-
                jq --argfile f1 /tmp/dna.json --argfile f2 /tmp/extra.json -n '$f1 + $f2 | .cfncluster = $f1.cfncluster + $f2.cfncluster' > /etc/chef/dna.json || ( echo "jq not installed"; cp /tmp/dna.json /etc/chef/dna.json
                )
        chefPrepEnv:
          commands:
            chef:
              command: >-
                chef-client --local-mode --config /etc/chef/client.rb --log_level auto --force-formatter --no-color --chef-zero-port 8889 --json-attributes /etc/chef/dna.json --override-runlist aws-parallelcluster::_prep_env
              cwd: /etc/chef
        shellRunPreInstall:
          commands:
            runpreinstall:
              command: /opt/parallelcluster/scripts/fetch_and_run -preinstall
        chefConfig:
          commands:
            chef:
              command: chef-client --local-mode --config /etc/chef/client.rb --log_level auto --force-formatter --no-color --chef-zero-port 8889 --json-attributes /etc/chef/dna.json
              cwd: /etc/chef
        shellRunPostInstall:
          commands:
            runpostinstall:
              command: /opt/parallelcluster/scripts/fetch_and_run -postinstall
        chefFinalize:
          commands:
            chef:
              command: >-
                chef-client --local-mode --config /etc/chef/client.rb --log_level auto --force-formatter --no-color --chef-zero-port 8889 --json-attributes /etc/chef/dna.json --override-runlist aws-parallelcluster::finalize
              cwd: /etc/chef
  ASGqueue1c52xlarge:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      MaxSize: '2'
      VPCZoneIdentifier:
        - subnet-0f45a3009addd0e7f
      LaunchTemplate:
        LaunchTemplateId: !Ref LaunchTemplatequeue1c52xlarge
        Version: !GetAtt 'LaunchTemplatequeue1c52xlarge.LatestVersionNumber'
      MinSize: '2'
      DesiredCapacity: '2'
      NotificationConfigurations:
        - TopicARN: !Ref 'SNS'
          NotificationTypes:
            - autoscaling:EC2_INSTANCE_TERMINATE
            - autoscaling:EC2_INSTANCE_LAUNCH
      PlacementGroup: !Ref AWS::NoValue
      MetricsCollection:
        - Granularity: 1Minute
          Metrics:
            - GroupDesiredCapacity
            - GroupInServiceInstances
            - GroupTerminatingInstances
            - GroupTotalInstances
    CreationPolicy:
      ResourceSignal:
        Timeout: PT30M
        Count: '2'
  LaunchTemplatequeue1c52xlarge:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateData:
        InstanceType: c5.2xlarge
        NetworkInterfaces:
          - DeviceIndex: 0
            InterfaceType: !Ref AWS::NoValue
            Groups:
              - !Ref 'ComputeSecurityGroup'
            AssociatePublicIpAddress: true
            SubnetId: subnet-0f45a3009addd0e7f
        KeyName: !Ref 'KeyName'
        IamInstanceProfile:
          Name: !Ref 'RootInstanceProfile'
        ImageId: !Ref 'ImageId'
        Monitoring:
          Enabled: false
        BlockDeviceMappings:
          - DeviceName: /dev/xvdba
            VirtualName: ephemeral0
          - DeviceName: /dev/xvdbb
            VirtualName: ephemeral1
          - DeviceName: /dev/xvdbc
            VirtualName: ephemeral2
          - DeviceName: /dev/xvdbd
            VirtualName: ephemeral3
          - DeviceName: /dev/xvdbe
            VirtualName: ephemeral4
          - DeviceName: /dev/xvdbf
            VirtualName: ephemeral5
          - DeviceName: /dev/xvdbg
            VirtualName: ephemeral6
          - DeviceName: /dev/xvdbh
            VirtualName: ephemeral7
          - DeviceName: /dev/xvdbi
            VirtualName: ephemeral8
          - DeviceName: /dev/xvdbj
            VirtualName: ephemeral9
          - DeviceName: /dev/xvdbk
            VirtualName: ephemeral10
          - DeviceName: /dev/xvdbl
            VirtualName: ephemeral11
          - DeviceName: /dev/xvdbm
            VirtualName: ephemeral12
          - DeviceName: /dev/xvdbn
            VirtualName: ephemeral13
          - DeviceName: /dev/xvdbo
            VirtualName: ephemeral14
          - DeviceName: /dev/xvdbp
            VirtualName: ephemeral15
          - DeviceName: /dev/xvdbq
            VirtualName: ephemeral16
          - DeviceName: /dev/xvdbr
            VirtualName: ephemeral17
          - DeviceName: /dev/xvdbs
            VirtualName: ephemeral18
          - DeviceName: /dev/xvdbt
            VirtualName: ephemeral19
          - DeviceName: /dev/xvdbu
            VirtualName: ephemeral20
          - DeviceName: /dev/xvdbv
            VirtualName: ephemeral21
          - DeviceName: /dev/xvdbw
            VirtualName: ephemeral22
          - DeviceName: /dev/xvdbx
            VirtualName: ephemeral23
          - DeviceName: /dev/xvda
            Ebs:
              VolumeSize: 25
              VolumeType: gp2
        UserData:
          Fn::Base64:
            !Sub |
            Content-Type: multipart/mixed; boundary="==BOUNDARY=="
            MIME-Version: 1.0

            --==BOUNDARY==
            Content-Type: text/cloud-boothook; charset=us-ascii
            MIME-Version: 1.0

            #!/bin/bash -x

            which yum && echo "proxy=_none_" >> /etc/yum.conf || echo "Not yum system"
            which apt-get && echo "Acquire::http::Proxy \"false\";" >> /etc/apt/apt.conf || echo "Not apt system"
            proxy=NONE
            if [ ${!proxy} != NONE ]; then
              proxy_host=$(echo "${!proxy}" | awk -F/ '{print $3}' | cut -d: -f1)
              proxy_port=$(echo "${!proxy}" | awk -F/ '{print $3}' | cut -d: -f2)
              echo -e "[Boto]\nproxy = ${!proxy_host}\nproxy_port = ${!proxy_port}\n" > /etc/boto.cfg
              cat >> /etc/profile.d/proxy.sh <<PROXY
            export http_proxy="${!proxy}"
            export https_proxy="${!proxy}"
            export no_proxy="localhost,127.0.0.1,169.254.169.254"
            export HTTP_PROXY="${!proxy}"
            export HTTPS_PROXY="${!proxy}"
            export NO_PROXY="localhost,127.0.0.1,169.254.169.254"
            PROXY
            fi

            --==BOUNDARY==
            Content-Type: text/x-shellscript; charset=us-ascii
            MIME-Version: 1.0

            #!/bin/bash -x

            function error_exit
            {
              region=${AWS::Region}
              instance_id=$(curl --retry 3 --retry-delay 0 --silent --fail http://169.254.169.254/latest/meta-data/instance-id)
              log_dir=/home/logs/compute
              mkdir -p ${!log_dir}
              echo "Reporting instance as unhealthy and dumping logs to ${!log_dir}/${!instance_id}.tar.gz"
              tar -czf ${!log_dir}/${!instance_id}.tar.gz /var/log
              aws --region ${AWS::Region} autoscaling set-instance-health --instance-id ${!instance_id} --health-status Unhealthy
              cfn-signal --exit-code=1 --reason="$1" --stack="${AWS::StackName}" --resource=ASGqueue1c52xlarge --region=${AWS::Region}
              exit 1
            }
            function vendor_cookbook
            {
              mkdir /tmp/cookbooks
              cd /tmp/cookbooks
              tar -xzf /etc/chef/aws-parallelcluster-cookbook.tgz
              HOME_BAK="${!HOME}"
              export HOME="/tmp"
              for d in `ls /tmp/cookbooks`; do
                cd /tmp/cookbooks/$d
                LANG=en_US.UTF-8 /opt/chef/embedded/bin/berks vendor /etc/chef/cookbooks --delete || error_exit 'Vendoring cookbook failed.'
              done;
              export HOME="${!HOME_BAK}"
            }
            function bootstrap_instance
            {
              which yum 2>/dev/null; yum=$?
              which apt-get 2>/dev/null; apt=$?
              if [ "${!yum}" == "0" ]; then
                yum -y groupinstall development && yum -y install curl wget jq awscli
              fi
              if [ "${!apt}" == "0" ]; then
                apt-cache search build-essential; apt-get clean; apt-get update; apt-get -y install build-essential curl wget jq python-setuptools awscli
              fi
              [[ ${!_region} =~ ^cn- ]] && s3_url="cn-north-1.amazonaws.com.cn/cn-north-1-aws-parallelcluster"
              which cfn-init 2>/dev/null || ( curl -s -L -o /tmp/aws-cfn-bootstrap-latest.tar.gz https://s3.${S3Domain}/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz; easy_install -U /tmp/aws-cfn-bootstrap-latest.tar.gz)
              mkdir -p /etc/chef && chown -R root:root /etc/chef
              curl --retry 3 -L https://www.chef.io/chef/install.sh | bash -s -- -v ${!chef_version}
              /opt/chef/embedded/bin/gem install --no-rdoc --no-ri ridley:${!ridley_version} berkshelf:${!berkshelf_version} ffi-libarchive
              curl --retry 3 -s -L -o /etc/chef/aws-parallelcluster-cookbook.tgz ${!cookbook_url}
              curl --retry 3 -s -L -o /etc/chef/aws-parallelcluster-cookbook.tgz.date ${!cookbook_url}.date
              curl --retry 3 -s -L -o /etc/chef/aws-parallelcluster-cookbook.tgz.md5 ${!cookbook_url}.md5
              vendor_cookbook
              mkdir /opt/parallelcluster && echo ${!parallelcluster_version} | tee /opt/parallelcluster/.bootstrapped
            }
            [ -f /etc/profile.d/proxy.sh ] && . /etc/profile.d/proxy.sh
            custom_cookbook=NONE
            export _region=${AWS::Region}
            s3_url=${S3Domain}

            if [ "NONE" != "NONE" ]; then
              cookbook_url=NONE
            else
              cookbook_url=https://s3.${!_region}.${S3Domain}/${!_region}-aws-parallelcluster/cookbooks/aws-parallelcluster-cookbook-2.6.0.tgz
            fi
            export PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/opt/aws/bin
            export parallelcluster_version=aws-parallelcluster-2.6.0
            export cookbook_version=aws-parallelcluster-cookbook-2.6.0
            export chef_version=14.2.0
            export ridley_version=5.1.1
            export berkshelf_version=7.0.4

            if [ -f /opt/parallelcluster/.bootstrapped ]; then
              installed_version=$(cat /opt/parallelcluster/.bootstrapped)
              if [ "${!parallelcluster_version}" != "${!installed_version}" ]; then
                bootstrap_instance
              fi
            else
              bootstrap_instance
            fi
            if [ "${!custom_cookbook}" != "NONE" ]; then
              curl --retry 3 -v -L -o /etc/chef/aws-parallelcluster-cookbook.tgz -z "$(cat /etc/chef/aws-parallelcluster-cookbook.tgz.date)" ${!cookbook_url}
              vendor_cookbook
            fi
            cd /tmp

            while [ "${!masterServerStatus}" != "CREATE_COMPLETE" ] && [ "${!masterServerStatus}" != "UPDATE_COMPLETE" ]
            do
              sleep 3
              masterServerStatus=$(aws cloudformation describe-stack-resource --stack-name ${MainStackName} --logical-resource-id MasterServerWaitCondition --region ${AWS::Region} --query StackResourceDetail.ResourceStatus --output text 2>/dev/null)
            done

            # Call CloudFormation
            cfn-init -s ${AWS::StackName} -v -c default --role ${RootRole} -r LaunchTemplatequeue1c52xlarge --region ${AWS::Region} || error_exit 'Failed to run cfn-init. If --norollback was specified, check /var/log/cfn-init.log and /var/log/cloud-init-output.log.'
            cfn-signal --exit-code=0 --reason="ComputeServer setup complete" --stack=${AWS::StackName} --resource=ASGqueue1c52xlarge --region=${AWS::Region}

            # End of file
            --==BOUNDARY==
    Metadata:
      Comment: AWS ParallelCluster Compute server
      AWS::CloudFormation::Init:
        configSets:
          default:
            - deployConfigFiles
            - chefPrepEnv
            - shellRunPreInstall
            - chefConfig
            - shellRunPostInstall
            - chefFinalize
        deployConfigFiles:
          files:
            /tmp/dna.json:
              mode: '000644'
              owner: root
              group: root
              content:
                cfncluster:
                  stack_name: !Ref 'MainStackName'
                  enable_efa: false
                  cfn_raid_parameters: NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE
                  cfn_preinstall: NONE
                  cfn_preinstall_args:  NONE
                  cfn_postinstall:  NONE
                  cfn_postinstall_args:  NONE
                  cfn_region: !Ref 'AWS::Region'
                  cfn_efs: !Ref 'EFSId'
                  cfn_efs_shared_dir: NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE
                  cfn_fsx_fs_id: !Ref 'FSXId'
                  cfn_fsx_options: NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE
                  cfn_scheduler: slurm
                  cfn_scheduler_slots: !Ref 'AWS::NoValue'
                  cfn_scaledown_idletime: 10
                  cfn_encrypted_ephemeral: false
                  cfn_ephemeral_dir: /scratch
                  cfn_shared_dir: /shared
                  cfn_proxy: NONE
                  cfn_sqs_queue: !Ref 'SQS'
                  cfn_master: !Ref 'MasterServerPrivateDns'
                  cfn_node_type: ComputeFleet
                  cfn_cluster_user: ec2_user
                  enable_intel_hpc_platform: false
                  cfn_cluster_cw_logging_enabled: true
                run_list: 'recipe[aws-parallelcluster::slurm_config]'
            /etc/chef/client.rb:
              mode: '000644'
              owner: root
              group: root
              content: !Join
                - ''
                - - cookbook_path ['/etc/chef/cookbooks']
            /tmp/extra.json:
              mode: '000644'
              owner: root
              group: root
              content: '{}'
          commands:
            mkdir:
              command: mkdir -p /etc/chef/ohai/hints
            touch:
              command: touch /etc/chef/ohai/hints/ec2.json
            jq:
              command: >-
                jq --argfile f1 /tmp/dna.json --argfile f2 /tmp/extra.json -n '$f1 + $f2 | .cfncluster = $f1.cfncluster + $f2.cfncluster' > /etc/chef/dna.json || ( echo "jq not installed"; cp /tmp/dna.json /etc/chef/dna.json
                )
        chefPrepEnv:
          commands:
            chef:
              command: >-
                chef-client --local-mode --config /etc/chef/client.rb --log_level auto --force-formatter --no-color --chef-zero-port 8889 --json-attributes /etc/chef/dna.json --override-runlist aws-parallelcluster::_prep_env
              cwd: /etc/chef
        shellRunPreInstall:
          commands:
            runpreinstall:
              command: /opt/parallelcluster/scripts/fetch_and_run -preinstall
        chefConfig:
          commands:
            chef:
              command: chef-client --local-mode --config /etc/chef/client.rb --log_level auto --force-formatter --no-color --chef-zero-port 8889 --json-attributes /etc/chef/dna.json
              cwd: /etc/chef
        shellRunPostInstall:
          commands:
            runpostinstall:
              command: /opt/parallelcluster/scripts/fetch_and_run -postinstall
        chefFinalize:
          commands:
            chef:
              command: >-
                chef-client --local-mode --config /etc/chef/client.rb --log_level auto --force-formatter --no-color --chef-zero-port 8889 --json-attributes /etc/chef/dna.json --override-runlist aws-parallelcluster::finalize
              cwd: /etc/chef
  LaunchTemplatequeue2g38xlarge:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateData:
        InstanceType: g3.8xlarge
        NetworkInterfaces:
          - DeviceIndex: 0
            InterfaceType: !Ref AWS::NoValue
            Groups:
              - !Ref 'ComputeSecurityGroup'
            AssociatePublicIpAddress: true
            SubnetId: subnet-0f45a3009addd0e7f
        KeyName: !Ref 'KeyName'
        IamInstanceProfile:
          Name: !Ref 'RootInstanceProfile'
        ImageId: !Ref 'ImageId'
        Monitoring:
          Enabled: false
        BlockDeviceMappings:
          - DeviceName: /dev/xvdba
            VirtualName: ephemeral0
          - DeviceName: /dev/xvdbb
            VirtualName: ephemeral1
          - DeviceName: /dev/xvdbc
            VirtualName: ephemeral2
          - DeviceName: /dev/xvdbd
            VirtualName: ephemeral3
          - DeviceName: /dev/xvdbe
            VirtualName: ephemeral4
          - DeviceName: /dev/xvdbf
            VirtualName: ephemeral5
          - DeviceName: /dev/xvdbg
            VirtualName: ephemeral6
          - DeviceName: /dev/xvdbh
            VirtualName: ephemeral7
          - DeviceName: /dev/xvdbi
            VirtualName: ephemeral8
          - DeviceName: /dev/xvdbj
            VirtualName: ephemeral9
          - DeviceName: /dev/xvdbk
            VirtualName: ephemeral10
          - DeviceName: /dev/xvdbl
            VirtualName: ephemeral11
          - DeviceName: /dev/xvdbm
            VirtualName: ephemeral12
          - DeviceName: /dev/xvdbn
            VirtualName: ephemeral13
          - DeviceName: /dev/xvdbo
            VirtualName: ephemeral14
          - DeviceName: /dev/xvdbp
            VirtualName: ephemeral15
          - DeviceName: /dev/xvdbq
            VirtualName: ephemeral16
          - DeviceName: /dev/xvdbr
            VirtualName: ephemeral17
          - DeviceName: /dev/xvdbs
            VirtualName: ephemeral18
          - DeviceName: /dev/xvdbt
            VirtualName: ephemeral19
          - DeviceName: /dev/xvdbu
            VirtualName: ephemeral20
          - DeviceName: /dev/xvdbv
            VirtualName: ephemeral21
          - DeviceName: /dev/xvdbw
            VirtualName: ephemeral22
          - DeviceName: /dev/xvdbx
            VirtualName: ephemeral23
          - DeviceName: /dev/xvda
            Ebs:
              VolumeSize: 25
              VolumeType: gp2
        UserData:
          Fn::Base64:
            !Sub |
            Content-Type: multipart/mixed; boundary="==BOUNDARY=="
            MIME-Version: 1.0

            --==BOUNDARY==
            Content-Type: text/cloud-boothook; charset=us-ascii
            MIME-Version: 1.0

            #!/bin/bash -x

            which yum && echo "proxy=_none_" >> /etc/yum.conf || echo "Not yum system"
            which apt-get && echo "Acquire::http::Proxy \"false\";" >> /etc/apt/apt.conf || echo "Not apt system"
            proxy=NONE
            if [ ${!proxy} != NONE ]; then
              proxy_host=$(echo "${!proxy}" | awk -F/ '{print $3}' | cut -d: -f1)
              proxy_port=$(echo "${!proxy}" | awk -F/ '{print $3}' | cut -d: -f2)
              echo -e "[Boto]\nproxy = ${!proxy_host}\nproxy_port = ${!proxy_port}\n" > /etc/boto.cfg
              cat >> /etc/profile.d/proxy.sh <<PROXY
            export http_proxy="${!proxy}"
            export https_proxy="${!proxy}"
            export no_proxy="localhost,127.0.0.1,169.254.169.254"
            export HTTP_PROXY="${!proxy}"
            export HTTPS_PROXY="${!proxy}"
            export NO_PROXY="localhost,127.0.0.1,169.254.169.254"
            PROXY
            fi

            --==BOUNDARY==
            Content-Type: text/x-shellscript; charset=us-ascii
            MIME-Version: 1.0

            #!/bin/bash -x

            function error_exit
            {
              region=${AWS::Region}
              instance_id=$(curl --retry 3 --retry-delay 0 --silent --fail http://169.254.169.254/latest/meta-data/instance-id)
              log_dir=/home/logs/compute
              mkdir -p ${!log_dir}
              echo "Reporting instance as unhealthy and dumping logs to ${!log_dir}/${!instance_id}.tar.gz"
              tar -czf ${!log_dir}/${!instance_id}.tar.gz /var/log
              aws --region ${AWS::Region} autoscaling set-instance-health --instance-id ${!instance_id} --health-status Unhealthy
              cfn-signal --exit-code=1 --reason="$1" --stack="${AWS::StackName}" --resource=ASGqueue2g38xlarge --region=${AWS::Region}
              exit 1
            }
            function vendor_cookbook
            {
              mkdir /tmp/cookbooks
              cd /tmp/cookbooks
              tar -xzf /etc/chef/aws-parallelcluster-cookbook.tgz
              HOME_BAK="${!HOME}"
              export HOME="/tmp"
              for d in `ls /tmp/cookbooks`; do
                cd /tmp/cookbooks/$d
                LANG=en_US.UTF-8 /opt/chef/embedded/bin/berks vendor /etc/chef/cookbooks --delete || error_exit 'Vendoring cookbook failed.'
              done;
              export HOME="${!HOME_BAK}"
            }
            function bootstrap_instance
            {
              which yum 2>/dev/null; yum=$?
              which apt-get 2>/dev/null; apt=$?
              if [ "${!yum}" == "0" ]; then
                yum -y groupinstall development && yum -y install curl wget jq awscli
              fi
              if [ "${!apt}" == "0" ]; then
                apt-cache search build-essential; apt-get clean; apt-get update; apt-get -y install build-essential curl wget jq python-setuptools awscli
              fi
              [[ ${!_region} =~ ^cn- ]] && s3_url="cn-north-1.amazonaws.com.cn/cn-north-1-aws-parallelcluster"
              which cfn-init 2>/dev/null || ( curl -s -L -o /tmp/aws-cfn-bootstrap-latest.tar.gz https://s3.${S3Domain}/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz; easy_install -U /tmp/aws-cfn-bootstrap-latest.tar.gz)
              mkdir -p /etc/chef && chown -R root:root /etc/chef
              curl --retry 3 -L https://www.chef.io/chef/install.sh | bash -s -- -v ${!chef_version}
              /opt/chef/embedded/bin/gem install --no-rdoc --no-ri ridley:${!ridley_version} berkshelf:${!berkshelf_version} ffi-libarchive
              curl --retry 3 -s -L -o /etc/chef/aws-parallelcluster-cookbook.tgz ${!cookbook_url}
              curl --retry 3 -s -L -o /etc/chef/aws-parallelcluster-cookbook.tgz.date ${!cookbook_url}.date
              curl --retry 3 -s -L -o /etc/chef/aws-parallelcluster-cookbook.tgz.md5 ${!cookbook_url}.md5
              vendor_cookbook
              mkdir /opt/parallelcluster && echo ${!parallelcluster_version} | tee /opt/parallelcluster/.bootstrapped
            }
            [ -f /etc/profile.d/proxy.sh ] && . /etc/profile.d/proxy.sh
            custom_cookbook=NONE
            export _region=${AWS::Region}
            s3_url=${S3Domain}

            if [ "NONE" != "NONE" ]; then
              cookbook_url=NONE
            else
              cookbook_url=https://s3.${!_region}.${S3Domain}/${!_region}-aws-parallelcluster/cookbooks/aws-parallelcluster-cookbook-2.6.0.tgz
            fi
            export PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/opt/aws/bin
            export parallelcluster_version=aws-parallelcluster-2.6.0
            export cookbook_version=aws-parallelcluster-cookbook-2.6.0
            export chef_version=14.2.0
            export ridley_version=5.1.1
            export berkshelf_version=7.0.4

            if [ -f /opt/parallelcluster/.bootstrapped ]; then
              installed_version=$(cat /opt/parallelcluster/.bootstrapped)
              if [ "${!parallelcluster_version}" != "${!installed_version}" ]; then
                bootstrap_instance
              fi
            else
              bootstrap_instance
            fi
            if [ "${!custom_cookbook}" != "NONE" ]; then
              curl --retry 3 -v -L -o /etc/chef/aws-parallelcluster-cookbook.tgz -z "$(cat /etc/chef/aws-parallelcluster-cookbook.tgz.date)" ${!cookbook_url}
              vendor_cookbook
            fi
            cd /tmp

            while [ "${!masterServerStatus}" != "CREATE_COMPLETE" ] && [ "${!masterServerStatus}" != "UPDATE_COMPLETE" ]
            do
              sleep 3
              masterServerStatus=$(aws cloudformation describe-stack-resource --stack-name ${MainStackName} --logical-resource-id MasterServerWaitCondition --region ${AWS::Region} --query StackResourceDetail.ResourceStatus --output text 2>/dev/null)
            done

            # Call CloudFormation
            cfn-init -s ${AWS::StackName} -v -c default --role ${RootRole} -r LaunchTemplatequeue2g38xlarge --region ${AWS::Region} || error_exit 'Failed to run cfn-init. If --norollback was specified, check /var/log/cfn-init.log and /var/log/cloud-init-output.log.'
            cfn-signal --exit-code=0 --reason="ComputeServer setup complete" --stack=${AWS::StackName} --resource=ASGqueue2g38xlarge --region=${AWS::Region}

            # End of file
            --==BOUNDARY==
    Metadata:
      Comment: AWS ParallelCluster Compute server
      AWS::CloudFormation::Init:
        configSets:
          default:
            - deployConfigFiles
            - chefPrepEnv
            - shellRunPreInstall
            - chefConfig
            - shellRunPostInstall
            - chefFinalize
        deployConfigFiles:
          files:
            /tmp/dna.json:
              mode: '000644'
              owner: root
              group: root
              content:
                cfncluster:
                  stack_name: !Ref 'MainStackName'
                  enable_efa: false
                  cfn_raid_parameters: NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE
                  cfn_preinstall: NONE
                  cfn_preinstall_args:  NONE
                  cfn_postinstall:  NONE
                  cfn_postinstall_args:  NONE
                  cfn_region: !Ref 'AWS::Region'
                  cfn_efs: !Ref 'EFSId'
                  cfn_efs_shared_dir: NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE
                  cfn_fsx_fs_id: !Ref 'FSXId'
                  cfn_fsx_options: NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE,NONE
                  cfn_scheduler: slurm
                  cfn_scheduler_slots: !Ref 'AWS::NoValue'
                  cfn_scaledown_idletime: 10
                  cfn_encrypted_ephemeral: false
                  cfn_ephemeral_dir: /scratch
                  cfn_shared_dir: /shared
                  cfn_proxy: NONE
                  cfn_sqs_queue: !Ref 'SQS'
                  cfn_master: !Ref 'MasterServerPrivateDns'
                  cfn_node_type: ComputeFleet
                  cfn_cluster_user: ec2_user
                  enable_intel_hpc_platform: false
                  cfn_cluster_cw_logging_enabled: true
                run_list: 'recipe[aws-parallelcluster::slurm_config]'
            /etc/chef/client.rb:
              mode: '000644'
              owner: root
              group: root
              content: !Join
                - ''
                - - cookbook_path ['/etc/chef/cookbooks']
            /tmp/extra.json:
              mode: '000644'
              owner: root
              group: root
              content: '{}'
          commands:
            mkdir:
              command: mkdir -p /etc/chef/ohai/hints
            touch:
              command: touch /etc/chef/ohai/hints/ec2.json
            jq:
              command: >-
                jq --argfile f1 /tmp/dna.json --argfile f2 /tmp/extra.json -n '$f1 + $f2 | .cfncluster = $f1.cfncluster + $f2.cfncluster' > /etc/chef/dna.json || ( echo "jq not installed"; cp /tmp/dna.json /etc/chef/dna.json
                )
        chefPrepEnv:
          commands:
            chef:
              command: >-
                chef-client --local-mode --config /etc/chef/client.rb --log_level auto --force-formatter --no-color --chef-zero-port 8889 --json-attributes /etc/chef/dna.json --override-runlist aws-parallelcluster::_prep_env
              cwd: /etc/chef
        shellRunPreInstall:
          commands:
            runpreinstall:
              command: /opt/parallelcluster/scripts/fetch_and_run -preinstall
        chefConfig:
          commands:
            chef:
              command: chef-client --local-mode --config /etc/chef/client.rb --log_level auto --force-formatter --no-color --chef-zero-port 8889 --json-attributes /etc/chef/dna.json
              cwd: /etc/chef
        shellRunPostInstall:
          commands:
            runpostinstall:
              command: /opt/parallelcluster/scripts/fetch_and_run -postinstall
        chefFinalize:
          commands:
            chef:
              command: >-
                chef-client --local-mode --config /etc/chef/client.rb --log_level auto --force-formatter --no-color --chef-zero-port 8889 --json-attributes /etc/chef/dna.json --override-runlist aws-parallelcluster::finalize
              cwd: /etc/chef
  PlacementGroupqueue2:
    Type: AWS::EC2::PlacementGroup
    Properties:
      Strategy: cluster
